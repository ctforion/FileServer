{{> base.html}}
{{#content}}
<div class="upload-container">
    <div class="upload-header">
        <h1><i class="fas fa-cloud-upload-alt"></i> Upload Files</h1>
        <p>Upload files to {{current_folder_name}}</p>
    </div>

    <!-- Upload Area -->
    <div class="upload-zone" id="uploadZone">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3>Drag & Drop Files Here</h3>
            <p>or <button class="btn btn-link" onclick="document.getElementById('fileInput').click()">browse your computer</button></p>
            <input type="file" id="fileInput" multiple>
            
            <div class="upload-limits">
                <small>
                    <i class="fas fa-info-circle"></i>
                    Max file size: {{max_file_size}} | 
                    Allowed types: {{allowed_extensions}} |
                    {{remaining_storage}} storage remaining
                </small>
            </div>
        </div>
    </div>

    <!-- Upload Queue -->
    <div class="upload-queue" id="uploadQueue">
        <div class="queue-header">
            <h3>Upload Queue</h3>
            <div class="queue-actions">
                <button class="btn btn-secondary" onclick="pauseAll()" id="pauseBtn">
                    <i class="fas fa-pause"></i> Pause All
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    <i class="fas fa-times"></i> Clear All
                </button>
            </div>
        </div>
        
        <div class="queue-items" id="queueItems">
            <!-- Queue items will be dynamically added here -->
        </div>
        
        <div class="queue-summary" id="queueSummary">
            <div class="summary-stats">
                <span class="stat">
                    <i class="fas fa-file"></i>
                    <span id="totalFiles">0</span> files
                </span>
                <span class="stat">
                    <i class="fas fa-hdd"></i>
                    <span id="totalSize">0 B</span>
                </span>
                <span class="stat">
                    <i class="fas fa-clock"></i>
                    <span id="estimatedTime">--</span>
                </span>
            </div>
            
            <div class="overall-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgress"></div>
                </div>
                <span class="progress-text" id="progressText">Ready to upload</span>
            </div>
            
            <button class="btn btn-primary btn-large" onclick="startUpload()" id="startUploadBtn">
                <i class="fas fa-upload"></i> Start Upload
            </button>
        </div>
    </div>

    <!-- Upload Settings -->
    <div class="upload-settings">
        <div class="settings-group">
            <h4><i class="fas fa-cog"></i> Upload Settings</h4>
            
            <div class="setting-item">
                <label class="checkbox-label">
                    <input type="checkbox" id="createThumbnails" checked>
                    <span class="checkmark"></span>
                    Generate thumbnails for images
                </label>
            </div>
            
            <div class="setting-item">
                <label class="checkbox-label">
                    <input type="checkbox" id="overwriteFiles">
                    <span class="checkmark"></span>
                    Overwrite existing files
                </label>
            </div>
            
            <div class="setting-item">
                <label for="uploadFolder">Upload to folder:</label>
                <select id="uploadFolder">
                    <option value="{{current_folder_id}}">{{current_folder_name}}</option>
                    {{#folders}}
                    <option value="{{id}}">{{indent}}{{name}}</option>
                    {{/folders}}
                </select>
            </div>
        </div>
    </div>
</div>

<style>
.upload-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.upload-header {
    text-align: center;
    margin-bottom: 30px;
}

.upload-header h1 {
    color: #333;
    margin-bottom: 10px;
}

.upload-zone {
    margin-bottom: 30px;
}

.upload-area {
    border: 3px dashed #ddd;
    border-radius: 10px;
    padding: 60px 20px;
    text-align: center;
    background: #f9f9f9;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: #007bff;
    background: #e7f3ff;
}

.upload-area.drag-over {
    border-color: #28a745;
    background: #e8f5e8;
}

.upload-icon {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 20px;
}

.upload-area h3 {
    color: #333;
    margin-bottom: 10px;
}

.upload-area p {
    color: #6c757d;
    margin-bottom: 20px;
}

#fileInput {
    display: none;
}

.upload-limits {
    margin-top: 15px;
    color: #6c757d;
}

.upload-queue {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: none;
}

.upload-queue.active {
    display: block;
}

.queue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.queue-actions {
    display: flex;
    gap: 10px;
}

.queue-items {
    max-height: 400px;
    overflow-y: auto;
}

.queue-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
}

.queue-item:last-child {
    border-bottom: none;
}

.file-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 5px;
    margin-right: 15px;
    font-size: 18px;
    color: #6c757d;
}

.file-details {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 500;
    margin-bottom: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.file-meta {
    font-size: 12px;
    color: #6c757d;
}

.file-progress {
    width: 200px;
    margin: 0 15px;
}

.progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}

.progress-fill {
    height: 100%;
    background: #007bff;
    transition: width 0.3s ease;
}

.progress-text {
    font-size: 11px;
    color: #6c757d;
}

.file-actions {
    display: flex;
    gap: 5px;
}

.file-status {
    width: 80px;
    text-align: center;
    font-size: 12px;
    font-weight: 500;
}

.status-waiting { color: #6c757d; }
.status-uploading { color: #007bff; }
.status-completed { color: #28a745; }
.status-error { color: #dc3545; }
.status-paused { color: #ffc107; }

.queue-summary {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #eee;
}

.summary-stats {
    display: flex;
    gap: 30px;
    margin-bottom: 15px;
    justify-content: center;
}

.stat {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 14px;
    color: #6c757d;
}

.overall-progress {
    margin-bottom: 20px;
}

.upload-settings {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
}

.settings-group h4 {
    margin-bottom: 15px;
    color: #333;
}

.setting-item {
    margin-bottom: 15px;
}

.setting-item:last-child {
    margin-bottom: 0;
}

.setting-item label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.setting-item select {
    width: 100%;
    max-width: 300px;
}
</style>

<script>
class FileUploader {
    constructor() {
        this.files = [];
        this.activeUploads = 0;
        this.maxConcurrent = 3;
        this.isPaused = false;
        this.uploadFolder = '{{current_folder_id}}';
        
        this.initializeEvents();
    }
    
    initializeEvents() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        // Drag and drop events
        uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
        uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
        uploadArea.addEventListener('click', () => fileInput.click());
        
        // File input change
        fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
        
        // Upload folder change
        document.getElementById('uploadFolder').addEventListener('change', (e) => {
            this.uploadFolder = e.target.value;
        });
    }
    
    handleDragOver(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.add('drag-over');
    }
    
    handleDragLeave(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('drag-over');
    }
    
    handleDrop(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('drag-over');
        this.handleFiles(e.dataTransfer.files);
    }
    
    handleFiles(fileList) {
        const files = Array.from(fileList);
        
        files.forEach(file => {
            const fileObj = {
                id: Date.now() + Math.random(),
                file: file,
                name: file.name,
                size: file.size,
                type: file.type,
                status: 'waiting',
                progress: 0,
                xhr: null
            };
            
            this.files.push(fileObj);
            this.addFileToQueue(fileObj);
        });
        
        this.updateSummary();
        this.showQueue();
    }
    
    addFileToQueue(fileObj) {
        const queueItems = document.getElementById('queueItems');
        
        const item = document.createElement('div');
        item.className = 'queue-item';
        item.id = `file-${fileObj.id}`;
        
        const iconClass = this.getFileIcon(fileObj.type);
        
        item.innerHTML = `
            <div class="file-icon">
                <i class="fas ${iconClass}"></i>
            </div>
            <div class="file-details">
                <div class="file-name" title="${fileObj.name}">${fileObj.name}</div>
                <div class="file-meta">${this.formatFileSize(fileObj.size)} • ${fileObj.type || 'Unknown'}</div>
            </div>
            <div class="file-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">Waiting...</div>
            </div>
            <div class="file-status status-waiting">Waiting</div>
            <div class="file-actions">
                <button class="btn btn-icon" onclick="uploader.removeFile('${fileObj.id}')" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        queueItems.appendChild(item);
    }
    
    showQueue() {
        document.getElementById('uploadQueue').classList.add('active');
    }
    
    updateSummary() {
        const totalFiles = this.files.length;
        const totalSize = this.files.reduce((sum, file) => sum + file.size, 0);
        
        document.getElementById('totalFiles').textContent = totalFiles;
        document.getElementById('totalSize').textContent = this.formatFileSize(totalSize);
        
        // Calculate estimated time (rough estimate based on 1MB/s)
        const estimatedSeconds = totalSize / (1024 * 1024);
        document.getElementById('estimatedTime').textContent = this.formatTime(estimatedSeconds);
    }
    
    async startUpload() {
        if (this.files.length === 0) return;
        
        const startBtn = document.getElementById('startUploadBtn');
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        
        this.isPaused = false;
        document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> Pause All';
        
        for (const file of this.files) {
            if (file.status === 'waiting') {
                while (this.activeUploads >= this.maxConcurrent || this.isPaused) {
                    await this.sleep(100);
                }
                
                if (file.status === 'waiting') {
                    this.uploadFile(file);
                }
            }
        }
    }
    
    async uploadFile(fileObj) {
        this.activeUploads++;
        this.updateFileStatus(fileObj.id, 'uploading', 'Uploading...');
        
        const formData = new FormData();
        formData.append('file', fileObj.file);
        formData.append('folder_id', this.uploadFolder);
        formData.append('create_thumbnails', document.getElementById('createThumbnails').checked);
        formData.append('overwrite', document.getElementById('overwriteFiles').checked);
        
        const xhr = new XMLHttpRequest();
        fileObj.xhr = xhr;
        
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percentage = (e.loaded / e.total) * 100;
                this.updateFileProgress(fileObj.id, percentage);
            }
        };
        
        xhr.onload = () => {
            this.activeUploads--;
            
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        this.updateFileStatus(fileObj.id, 'completed', 'Completed');
                        fileObj.status = 'completed';
                    } else {
                        this.updateFileStatus(fileObj.id, 'error', response.message || 'Upload failed');
                        fileObj.status = 'error';
                    }
                } catch (e) {
                    this.updateFileStatus(fileObj.id, 'error', 'Invalid response');
                    fileObj.status = 'error';
                }
            } else {
                this.updateFileStatus(fileObj.id, 'error', `HTTP ${xhr.status}`);
                fileObj.status = 'error';
            }
            
            this.checkUploadComplete();
        };
        
        xhr.onerror = () => {
            this.activeUploads--;
            this.updateFileStatus(fileObj.id, 'error', 'Network error');
            fileObj.status = 'error';
            this.checkUploadComplete();
        };
        
        xhr.open('POST', '{{base_url}}/api/files/upload');
        xhr.send(formData);
    }
    
    updateFileProgress(fileId, percentage) {
        const item = document.getElementById(`file-${fileId}`);
        if (item) {
            const progressFill = item.querySelector('.progress-fill');
            const progressText = item.querySelector('.progress-text');
            
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${Math.round(percentage)}%`;
        }
        
        this.updateOverallProgress();
    }
    
    updateFileStatus(fileId, status, message) {
        const item = document.getElementById(`file-${fileId}`);
        if (item) {
            const statusEl = item.querySelector('.file-status');
            const progressText = item.querySelector('.progress-text');
            
            statusEl.textContent = message;
            statusEl.className = `file-status status-${status}`;
            progressText.textContent = message;
        }
    }
    
    updateOverallProgress() {
        const completedFiles = this.files.filter(f => f.status === 'completed').length;
        const totalFiles = this.files.length;
        const percentage = totalFiles > 0 ? (completedFiles / totalFiles) * 100 : 0;
        
        document.getElementById('overallProgress').style.width = `${percentage}%`;
        document.getElementById('progressText').textContent = 
            `${completedFiles} of ${totalFiles} files completed`;
    }
    
    checkUploadComplete() {
        const pendingFiles = this.files.filter(f => f.status === 'waiting' || f.status === 'uploading');
        
        if (pendingFiles.length === 0) {
            const startBtn = document.getElementById('startUploadBtn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-check"></i> Upload Complete';
            
            const completedCount = this.files.filter(f => f.status === 'completed').length;
            const errorCount = this.files.filter(f => f.status === 'error').length;
            
            if (errorCount === 0) {
                setTimeout(() => {
                    if (confirm(`Upload complete! ${completedCount} files uploaded successfully. Go to dashboard?`)) {
                        window.location.href = '{{base_url}}/dashboard';
                    }
                }, 1000);
            }
        }
    }
    
    removeFile(fileId) {
        const index = this.files.findIndex(f => f.id == fileId);
        if (index > -1) {
            const file = this.files[index];
            if (file.xhr) {
                file.xhr.abort();
            }
            
            this.files.splice(index, 1);
            document.getElementById(`file-${fileId}`).remove();
            this.updateSummary();
            
            if (this.files.length === 0) {
                document.getElementById('uploadQueue').classList.remove('active');
            }
        }
    }
    
    pauseAll() {
        this.isPaused = !this.isPaused;
        const pauseBtn = document.getElementById('pauseBtn');
        
        if (this.isPaused) {
            pauseBtn.innerHTML = '<i class="fas fa-play"></i> Resume All';
        } else {
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause All';
        }
    }
    
    clearAll() {
        if (confirm('Are you sure you want to clear all files from the queue?')) {
            this.files.forEach(file => {
                if (file.xhr) {
                    file.xhr.abort();
                }
            });
            
            this.files = [];
            document.getElementById('queueItems').innerHTML = '';
            document.getElementById('uploadQueue').classList.remove('active');
        }
    }
    
    getFileIcon(mimeType) {
        if (mimeType.startsWith('image/')) return 'fa-file-image';
        if (mimeType.startsWith('video/')) return 'fa-file-video';
        if (mimeType.startsWith('audio/')) return 'fa-file-audio';
        if (mimeType.includes('pdf')) return 'fa-file-pdf';
        if (mimeType.includes('word')) return 'fa-file-word';
        if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fa-file-excel';
        if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'fa-file-powerpoint';
        if (mimeType.includes('zip') || mimeType.includes('archive')) return 'fa-file-archive';
        return 'fa-file';
    }
    
    formatFileSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB'];
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
    }
    
    formatTime(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}s`;
        if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
        return `${Math.round(seconds / 3600)}h`;
    }
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Initialize uploader
const uploader = new FileUploader();

// Global functions for buttons
function startUpload() { uploader.startUpload(); }
function pauseAll() { uploader.pauseAll(); }
function clearAll() { uploader.clearAll(); }
</script>
{{/content}}
