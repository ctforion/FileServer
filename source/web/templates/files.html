{{> base.html}}
{{#content}}
<div class="files-container">
    <!-- Files Header -->
    <div class="files-header">
        <div class="header-info">
            <h1><i class="fas fa-folder-open"></i> {{folder_name}}</h1>
            <p class="folder-path">{{folder_path}}</p>
        </div>
        
        <div class="header-actions">
            <button class="btn btn-primary" onclick="window.location.href='{{base_url}}/upload?folder={{folder_id}}'">
                <i class="fas fa-upload"></i> Upload
            </button>
            <button class="btn btn-secondary" onclick="createNewFolder()">
                <i class="fas fa-folder-plus"></i> New Folder
            </button>
            {{#can_share_folder}}
            <button class="btn btn-secondary" onclick="shareFolder()">
                <i class="fas fa-share-alt"></i> Share Folder
            </button>
            {{/can_share_folder}}
        </div>
    </div>

    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb">
        <a href="{{base_url}}/files" class="breadcrumb-item">
            <i class="fas fa-home"></i> Files
        </a>
        {{#breadcrumb}}
        <span class="breadcrumb-separator">/</span>
        <a href="{{url}}" class="breadcrumb-item">{{name}}</a>
        {{/breadcrumb}}
    </div>

    <!-- File Browser -->
    <div class="file-browser">
        <!-- Toolbar -->
        <div class="browser-toolbar">
            <div class="view-options">
                <button class="btn btn-icon {{#if grid_view}}active{{/if}}" onclick="setViewMode('grid')" title="Grid View">
                    <i class="fas fa-th"></i>
                </button>
                <button class="btn btn-icon {{#unless grid_view}}active{{/unless}}" onclick="setViewMode('list')" title="List View">
                    <i class="fas fa-list"></i>
                </button>
            </div>
            
            <div class="sort-options">
                <select id="sortBy" onchange="sortFiles(this.value)">
                    <option value="name" {{#if sort_name}}selected{{/if}}>Name</option>
                    <option value="date" {{#if sort_date}}selected{{/if}}>Date Modified</option>
                    <option value="size" {{#if sort_size}}selected{{/if}}>Size</option>
                    <option value="type" {{#if sort_type}}selected{{/if}}>Type</option>
                </select>
                
                <button class="btn btn-icon" onclick="toggleSortOrder()" title="Sort Order">
                    <i class="fas {{#if sort_desc}}fa-sort-amount-down{{else}}fa-sort-amount-up{{/if}}"></i>
                </button>
            </div>
            
            <div class="browser-actions">
                <button class="btn btn-icon" onclick="refreshFiles()" title="Refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <button class="btn btn-icon" onclick="toggleSelectMode()" id="selectModeBtn" title="Select Mode">
                    <i class="fas fa-check-square"></i>
                </button>
                
                <div class="search-box">
                    <input type="text" placeholder="Search files..." id="searchInput" value="{{search_query}}">
                    <button class="search-btn" onclick="searchFiles()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- File Grid/List -->
        <div class="file-grid {{#unless grid_view}}list-view{{/unless}}" id="fileGrid">
            {{#has_parent}}
            <div class="file-item folder parent-folder" onclick="goToParent()">
                <div class="file-icon">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">.. (Up one level)</div>
                    <div class="file-meta">Parent Directory</div>
                </div>
            </div>
            {{/has_parent}}
            
            {{#folders}}
            <div class="file-item folder" data-id="{{id}}" data-type="folder" data-name="{{name}}">
                <div class="file-checkbox">
                    <input type="checkbox" class="item-select" value="{{id}}" data-type="folder">
                </div>
                
                <div class="file-icon" onclick="openFolder('{{id}}')">
                    <i class="fas fa-folder"></i>
                </div>
                
                <div class="file-info" onclick="openFolder('{{id}}')">
                    <div class="file-name">{{name}}</div>
                    <div class="file-meta">
                        <span class="file-date">{{date_modified}}</span>
                        {{#item_count}}
                        <span class="item-count">{{item_count}} items</span>
                        {{/item_count}}
                    </div>
                </div>
                
                <div class="file-actions">
                    <button class="btn btn-icon" onclick="shareItem('{{id}}', 'folder')" title="Share">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="btn btn-icon" onclick="renameItem('{{id}}', 'folder')" title="Rename">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-icon" onclick="moveItem('{{id}}', 'folder')" title="Move">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="btn btn-icon btn-danger" onclick="deleteItem('{{id}}', 'folder')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {{/folders}}
            
            {{#files}}
            <div class="file-item file" data-id="{{id}}" data-type="file" data-name="{{name}}">
                <div class="file-checkbox">
                    <input type="checkbox" class="item-select" value="{{id}}" data-type="file">
                </div>
                
                <div class="file-icon" onclick="previewFile('{{id}}')">
                    {{#thumbnail}}
                    <img src="{{thumbnail}}" alt="{{name}}" class="file-thumbnail">
                    {{/thumbnail}}
                    {{^thumbnail}}
                    <i class="fas {{icon_class}}"></i>
                    {{/thumbnail}}
                    
                    {{#is_shared}}
                    <div class="file-badge shared-badge">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    {{/is_shared}}
                </div>
                
                <div class="file-info" onclick="previewFile('{{id}}')">
                    <div class="file-name">{{name}}</div>
                    <div class="file-meta">
                        <span class="file-size">{{formatted_size}}</span>
                        <span class="file-date">{{date_modified}}</span>
                        {{#mime_type}}
                        <span class="file-type">{{file_extension}}</span>
                        {{/mime_type}}
                    </div>
                </div>
                
                <div class="file-actions">
                    <button class="btn btn-icon" onclick="downloadFile('{{id}}')" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-icon" onclick="shareItem('{{id}}', 'file')" title="Share">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="btn btn-icon" onclick="renameItem('{{id}}', 'file')" title="Rename">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-icon" onclick="moveItem('{{id}}', 'file')" title="Move">
                        <i class="fas fa-arrows-alt"></i>
                    </button>
                    <button class="btn btn-icon btn-danger" onclick="deleteItem('{{id}}', 'file')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {{/files}}
            
            {{#empty_folder}}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
                <h3>This folder is empty</h3>
                <p>Upload files or create folders to get started</p>
                <div class="empty-actions">
                    <button class="btn btn-primary" onclick="window.location.href='{{base_url}}/upload?folder={{folder_id}}'">
                        <i class="fas fa-upload"></i> Upload Files
                    </button>
                    <button class="btn btn-secondary" onclick="createNewFolder()">
                        <i class="fas fa-folder-plus"></i> Create Folder
                    </button>
                </div>
            </div>
            {{/empty_folder}}
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div class="bulk-actions" id="bulkActions" style="display: none;">
        <div class="bulk-info">
            <span id="selectedCount">0</span> items selected
        </div>
        <div class="bulk-buttons">
            <button class="btn btn-secondary" onclick="downloadSelected()">
                <i class="fas fa-download"></i> Download
            </button>
            <button class="btn btn-secondary" onclick="shareSelected()">
                <i class="fas fa-share-alt"></i> Share
            </button>
            <button class="btn btn-secondary" onclick="moveSelected()">
                <i class="fas fa-arrows-alt"></i> Move
            </button>
            <button class="btn btn-danger" onclick="deleteSelected()">
                <i class="fas fa-trash"></i> Delete
            </button>
            <button class="btn btn-outline" onclick="clearSelection()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Pagination -->
    {{#pagination}}
    <div class="pagination">
        {{#has_previous}}
        <a href="{{previous_url}}" class="page-btn">
            <i class="fas fa-chevron-left"></i> Previous
        </a>
        {{/has_previous}}
        
        <div class="page-info">
            Page {{current_page}} of {{total_pages}} ({{total_items}} items)
        </div>
        
        {{#has_next}}
        <a href="{{next_url}}" class="page-btn">
            Next <i class="fas fa-chevron-right"></i>
        </a>
        {{/has_next}}
    </div>
    {{/pagination}}
</div>

<!-- File Preview Modal -->
<div class="modal" id="previewModal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="previewTitle">File Preview</h3>
            <div class="modal-actions">
                <button class="btn btn-icon" onclick="downloadCurrentFile()" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-icon" onclick="shareCurrentFile()" title="Share">
                    <i class="fas fa-share-alt"></i>
                </button>
                <button class="modal-close" onclick="closePreview()">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div id="previewContent"></div>
        </div>
    </div>
</div>

<script>
let currentFolder = '{{folder_id}}';
let selectMode = false;
let currentPreviewFile = null;

// View mode functions
function setViewMode(mode) {
    const grid = document.getElementById('fileGrid');
    grid.classList.toggle('list-view', mode === 'list');
    
    // Update buttons
    document.querySelectorAll('.view-options .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Save preference
    localStorage.setItem('fileViewMode', mode);
}

// Sorting functions
function sortFiles(sortBy) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    window.location.href = url.toString();
}

function toggleSortOrder() {
    const url = new URL(window.location);
    const currentOrder = url.searchParams.get('order') || 'asc';
    url.searchParams.set('order', currentOrder === 'asc' ? 'desc' : 'asc');
    window.location.href = url.toString();
}

// Search function
function searchFiles() {
    const query = document.getElementById('searchInput').value;
    const url = new URL(window.location);
    
    if (query.trim()) {
        url.searchParams.set('search', query);
    } else {
        url.searchParams.delete('search');
    }
    
    window.location.href = url.toString();
}

// Selection functions
function toggleSelectMode() {
    selectMode = !selectMode;
    document.body.classList.toggle('select-mode', selectMode);
    document.getElementById('selectModeBtn').classList.toggle('active', selectMode);
    
    if (!selectMode) {
        clearSelection();
    }
}

function clearSelection() {
    document.querySelectorAll('.item-select').forEach(cb => {
        cb.checked = false;
    });
    updateBulkActions();
}

function updateBulkActions() {
    const selected = document.querySelectorAll('.item-select:checked');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = selected.length;
    bulkActions.style.display = selected.length > 0 ? 'flex' : 'none';
}

// Navigation functions
function openFolder(folderId) {
    window.location.href = `{{base_url}}/files?folder=${folderId}`;
}

function goToParent() {
    window.location.href = '{{parent_url}}';
}

function refreshFiles() {
    window.location.reload();
}

// File operations
function previewFile(fileId) {
    currentPreviewFile = fileId;
    
    // Fetch file info and content
    fetch(`{{base_url}}/api/files/preview/${fileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPreview(data.file);
            } else {
                alert('Could not load file preview: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Preview error:', error);
            alert('Error loading file preview');
        });
}

function showPreview(file) {
    const modal = document.getElementById('previewModal');
    const title = document.getElementById('previewTitle');
    const content = document.getElementById('previewContent');
    
    title.textContent = file.name;
    
    // Generate preview based on file type
    if (file.mime_type.startsWith('image/')) {
        content.innerHTML = `<img src="${file.url}" alt="${file.name}" class="preview-image">`;
    } else if (file.mime_type.startsWith('video/')) {
        content.innerHTML = `<video controls class="preview-video"><source src="${file.url}" type="${file.mime_type}"></video>`;
    } else if (file.mime_type.startsWith('audio/')) {
        content.innerHTML = `<audio controls class="preview-audio"><source src="${file.url}" type="${file.mime_type}"></audio>`;
    } else if (file.mime_type === 'application/pdf') {
        content.innerHTML = `<iframe src="${file.url}" class="preview-pdf"></iframe>`;
    } else if (file.mime_type.startsWith('text/') || file.mime_type.includes('json') || file.mime_type.includes('xml')) {
        content.innerHTML = `<pre class="preview-text">${file.content || 'Loading...'}</pre>`;
    } else {
        content.innerHTML = `
            <div class="preview-placeholder">
                <i class="fas ${getFileIcon(file.mime_type)} fa-3x"></i>
                <h3>${file.name}</h3>
                <p>Preview not available for this file type</p>
                <button class="btn btn-primary" onclick="downloadFile('${file.id}')">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        `;
    }
    
    modal.style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
    currentPreviewFile = null;
}

function downloadFile(fileId) {
    window.open(`{{base_url}}/api/files/download/${fileId}`, '_blank');
}

function downloadCurrentFile() {
    if (currentPreviewFile) {
        downloadFile(currentPreviewFile);
    }
}

function shareCurrentFile() {
    if (currentPreviewFile) {
        shareItem(currentPreviewFile, 'file');
    }
}

// Item operations
function shareItem(itemId, type) {
    // Implementation for sharing
    console.log('Share', type, itemId);
}

function renameItem(itemId, type) {
    const item = document.querySelector(`[data-id="${itemId}"]`);
    const currentName = item.dataset.name;
    const newName = prompt(`Enter new name for this ${type}:`, currentName);
    
    if (newName && newName !== currentName) {
        // Send rename request
        fetch(`{{base_url}}/api/files/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: itemId,
                type: type,
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Rename failed: ' + data.message);
            }
        });
    }
}

function moveItem(itemId, type) {
    // Implementation for moving items
    console.log('Move', type, itemId);
}

function deleteItem(itemId, type) {
    if (confirm(`Are you sure you want to delete this ${type}?`)) {
        fetch(`{{base_url}}/api/files/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: itemId,
                type: type
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-id="${itemId}"]`).remove();
            } else {
                alert('Delete failed: ' + data.message);
            }
        });
    }
}

// Bulk operations
function downloadSelected() {
    const selected = Array.from(document.querySelectorAll('.item-select:checked'))
        .map(cb => ({ id: cb.value, type: cb.dataset.type }));
    
    if (selected.length === 0) return;
    
    // Create download for selected items
    console.log('Download selected:', selected);
}

function shareSelected() {
    const selected = Array.from(document.querySelectorAll('.item-select:checked'))
        .map(cb => ({ id: cb.value, type: cb.dataset.type }));
    
    if (selected.length === 0) return;
    
    console.log('Share selected:', selected);
}

function moveSelected() {
    const selected = Array.from(document.querySelectorAll('.item-select:checked'))
        .map(cb => ({ id: cb.value, type: cb.dataset.type }));
    
    if (selected.length === 0) return;
    
    console.log('Move selected:', selected);
}

function deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.item-select:checked'))
        .map(cb => ({ id: cb.value, type: cb.dataset.type }));
    
    if (selected.length === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selected.length} items?`)) {
        console.log('Delete selected:', selected);
    }
}

// Utility functions
function createNewFolder() {
    const name = prompt('Enter folder name:');
    if (name) {
        fetch(`{{base_url}}/api/files/create-folder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                parent_id: currentFolder
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Create folder failed: ' + data.message);
            }
        });
    }
}

function shareFolder() {
    console.log('Share folder:', currentFolder);
}

function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'fa-file-image';
    if (mimeType.startsWith('video/')) return 'fa-file-video';
    if (mimeType.startsWith('audio/')) return 'fa-file-audio';
    if (mimeType.includes('pdf')) return 'fa-file-pdf';
    if (mimeType.includes('word')) return 'fa-file-word';
    if (mimeType.includes('excel')) return 'fa-file-excel';
    if (mimeType.includes('powerpoint')) return 'fa-file-powerpoint';
    if (mimeType.includes('zip') || mimeType.includes('archive')) return 'fa-file-archive';
    return 'fa-file';
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Selection change handling
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('item-select')) {
            updateBulkActions();
        }
    });
    
    // Search on Enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchFiles();
        }
    });
    
    // Load saved view mode
    const savedViewMode = localStorage.getItem('fileViewMode');
    if (savedViewMode) {
        setViewMode(savedViewMode);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 'a':
                e.preventDefault();
                if (selectMode) {
                    document.querySelectorAll('.item-select').forEach(cb => cb.checked = true);
                    updateBulkActions();
                }
                break;
                
            case 'u':
                e.preventDefault();
                window.location.href = `{{base_url}}/upload?folder=${currentFolder}`;
                break;
        }
    }
    
    if (e.key === 'Escape') {
        if (selectMode) {
            toggleSelectMode();
        }
        closePreview();
    }
});
</script>
{{/content}}
