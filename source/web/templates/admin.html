{{> base.html}}
{{#content}}
<div class="admin-container">
    <!-- Admin Header -->
    <div class="admin-header">
        <h1><i class="fas fa-cog"></i> Administration Panel</h1>
        <p>Manage your File Storage Server</p>
    </div>

    <!-- Admin Navigation -->
    <div class="admin-nav">
        <button class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
        <button class="nav-item" onclick="showSection('users')">
            <i class="fas fa-users"></i> Users
        </button>
        <button class="nav-item" onclick="showSection('files')">
            <i class="fas fa-file"></i> Files
        </button>
        <button class="nav-item" onclick="showSection('storage')">
            <i class="fas fa-hdd"></i> Storage
        </button>
        <button class="nav-item" onclick="showSection('settings')">
            <i class="fas fa-cog"></i> Settings
        </button>
        <button class="nav-item" onclick="showSection('logs')">
            <i class="fas fa-list-alt"></i> Logs
        </button>
        <button class="nav-item" onclick="showSection('maintenance')">
            <i class="fas fa-tools"></i> Maintenance
        </button>
    </div>

    <!-- Dashboard Section -->
    <div class="admin-section active" id="dashboard">
        <h2>System Overview</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>{{total_users}}</h3>
                    <p>Total Users</p>
                    <small>{{active_users}} active</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div class="stat-info">
                    <h3>{{total_files}}</h3>
                    <p>Total Files</p>
                    <small>{{files_today}} uploaded today</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-hdd"></i>
                </div>
                <div class="stat-info">
                    <h3>{{storage_used}}</h3>
                    <p>Storage Used</p>
                    <small>{{storage_available}} available</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-share-alt"></i>
                </div>
                <div class="stat-info">
                    <h3>{{total_shares}}</h3>
                    <p>Active Shares</p>
                    <small>{{shares_today}} created today</small>
                </div>
            </div>
        </div>

        <div class="dashboard-widgets">
            <div class="widget">
                <h3>Recent Activity</h3>
                <div class="activity-list">
                    {{#recent_activity}}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas {{icon}}"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-text">{{description}}</div>
                            <div class="activity-time">{{time_ago}}</div>
                        </div>
                    </div>
                    {{/recent_activity}}
                </div>
            </div>
            
            <div class="widget">
                <h3>System Status</h3>
                <div class="status-list">
                    <div class="status-item {{disk_status}}">
                        <span class="status-label">Disk Space</span>
                        <span class="status-value">{{disk_usage}}%</span>
                    </div>
                    <div class="status-item {{memory_status}}">
                        <span class="status-label">Memory</span>
                        <span class="status-value">{{memory_usage}}%</span>
                    </div>
                    <div class="status-item {{database_status}}">
                        <span class="status-label">Database</span>
                        <span class="status-value">{{database_status_text}}</span>
                    </div>
                    <div class="status-item {{backup_status}}">
                        <span class="status-label">Last Backup</span>
                        <span class="status-value">{{last_backup}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Section -->
    <div class="admin-section" id="users">
        <div class="section-header">
            <h2>User Management</h2>
            <button class="btn btn-primary" onclick="createUser()">
                <i class="fas fa-user-plus"></i> Add User
            </button>
        </div>
        
        <div class="users-table">
            <div class="table-filters">
                <input type="text" placeholder="Search users..." id="userSearch">
                <select id="userFilter">
                    <option value="">All Users</option>
                    <option value="admin">Administrators</option>
                    <option value="user">Regular Users</option>
                    <option value="banned">Banned Users</option>
                </select>
            </div>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Storage Used</th>
                        <th>Last Login</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#users}}
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">{{initial}}</div>
                                <div>
                                    <div class="user-name">{{username}}</div>
                                    <div class="user-id">ID: {{id}}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{email}}</td>
                        <td>
                            <span class="role-badge {{role}}">{{role_name}}</span>
                        </td>
                        <td>{{storage_used}} / {{storage_limit}}</td>
                        <td>{{last_login}}</td>
                        <td>
                            <span class="status-badge {{status}}">{{status_text}}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-icon" onclick="editUser('{{id}}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-icon" onclick="viewUserFiles('{{id}}')" title="View Files">
                                    <i class="fas fa-folder"></i>
                                </button>
                                <button class="btn btn-icon" onclick="loginAsUser('{{id}}')" title="Login As">
                                    <i class="fas fa-sign-in-alt"></i>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteUser('{{id}}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{/users}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Files Section -->
    <div class="admin-section" id="files">
        <div class="section-header">
            <h2>File Management</h2>
            <div class="section-actions">
                <button class="btn btn-secondary" onclick="cleanupOrphaned()">
                    <i class="fas fa-broom"></i> Cleanup Orphaned
                </button>
                <button class="btn btn-secondary" onclick="regenerateThumbnails()">
                    <i class="fas fa-image"></i> Regenerate Thumbnails
                </button>
            </div>
        </div>
        
        <div class="files-stats">
            <div class="stat-row">
                <span>Total Files:</span>
                <strong>{{total_files}}</strong>
            </div>
            <div class="stat-row">
                <span>Orphaned Files:</span>
                <strong>{{orphaned_files}}</strong>
            </div>
            <div class="stat-row">
                <span>Large Files (>100MB):</span>
                <strong>{{large_files}}</strong>
            </div>
        </div>
        
        <div class="files-table">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Owner</th>
                        <th>Size</th>
                        <th>Type</th>
                        <th>Upload Date</th>
                        <th>Downloads</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#files}}
                    <tr>
                        <td>
                            <div class="file-info">
                                <i class="fas {{icon_class}}"></i>
                                <div>
                                    <div class="file-name">{{name}}</div>
                                    <div class="file-path">{{path}}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{owner_username}}</td>
                        <td>{{formatted_size}}</td>
                        <td>{{mime_type}}</td>
                        <td>{{upload_date}}</td>
                        <td>{{download_count}}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-icon" onclick="downloadFile('{{id}}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-icon" onclick="viewFileShares('{{id}}')" title="View Shares">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="btn btn-icon btn-danger" onclick="deleteFile('{{id}}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {{/files}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Storage Section -->
    <div class="admin-section" id="storage">
        <h2>Storage Management</h2>
        
        <div class="storage-overview">
            <div class="storage-chart">
                <canvas id="storageChart"></canvas>
            </div>
            
            <div class="storage-details">
                <h3>Storage Breakdown</h3>
                <div class="storage-item">
                    <span class="storage-label">User Files</span>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: {{user_files_percentage}}%"></div>
                    </div>
                    <span class="storage-value">{{user_files_size}}</span>
                </div>
                
                <div class="storage-item">
                    <span class="storage-label">Thumbnails</span>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: {{thumbnails_percentage}}%"></div>
                    </div>
                    <span class="storage-value">{{thumbnails_size}}</span>
                </div>
                
                <div class="storage-item">
                    <span class="storage-label">Temporary Files</span>
                    <div class="storage-bar">
                        <div class="storage-fill" style="width: {{temp_files_percentage}}%"></div>
                    </div>
                    <span class="storage-value">{{temp_files_size}}</span>
                </div>
            </div>
        </div>
        
        <div class="storage-actions">
            <button class="btn btn-primary" onclick="cleanupTempFiles()">
                <i class="fas fa-broom"></i> Clean Temporary Files
            </button>
            <button class="btn btn-secondary" onclick="optimizeStorage()">
                <i class="fas fa-compress"></i> Optimize Storage
            </button>
            <button class="btn btn-secondary" onclick="runBackup()">
                <i class="fas fa-save"></i> Create Backup
            </button>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="admin-section" id="settings">
        <h2>System Settings</h2>
        
        <form id="settingsForm" class="settings-form">
            <div class="settings-group">
                <h3>General Settings</h3>
                
                <div class="form-group">
                    <label for="site_name">Site Name</label>
                    <input type="text" id="site_name" name="site_name" value="{{settings.site_name}}">
                </div>
                
                <div class="form-group">
                    <label for="max_file_size">Max File Size (MB)</label>
                    <input type="number" id="max_file_size" name="max_file_size" value="{{settings.max_file_size}}">
                </div>
                
                <div class="form-group">
                    <label for="default_storage_limit">Default Storage Limit (GB)</label>
                    <input type="number" id="default_storage_limit" name="default_storage_limit" value="{{settings.default_storage_limit}}">
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="registration_enabled" {{#if settings.registration_enabled}}checked{{/if}}>
                        <span class="checkmark"></span>
                        Allow User Registration
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="require_email_verification" {{#if settings.require_email_verification}}checked{{/if}}>
                        <span class="checkmark"></span>
                        Require Email Verification
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>Security Settings</h3>
                
                <div class="form-group">
                    <label for="session_timeout">Session Timeout (minutes)</label>
                    <input type="number" id="session_timeout" name="session_timeout" value="{{settings.session_timeout}}">
                </div>
                
                <div class="form-group">
                    <label for="max_login_attempts">Max Login Attempts</label>
                    <input type="number" id="max_login_attempts" name="max_login_attempts" value="{{settings.max_login_attempts}}">
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="force_https" {{#if settings.force_https}}checked{{/if}}>
                        <span class="checkmark"></span>
                        Force HTTPS
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3>File Settings</h3>
                
                <div class="form-group">
                    <label for="allowed_extensions">Allowed File Extensions</label>
                    <textarea id="allowed_extensions" name="allowed_extensions" rows="3">{{settings.allowed_extensions}}</textarea>
                    <small>Comma-separated list of extensions (e.g., jpg,png,pdf,doc)</small>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="generate_thumbnails" {{#if settings.generate_thumbnails}}checked{{/if}}>
                        <span class="checkmark"></span>
                        Generate Thumbnails
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="virus_scanning" {{#if settings.virus_scanning}}checked{{/if}}>
                        <span class="checkmark"></span>
                        Enable Virus Scanning
                    </label>
                </div>
            </div>
            
            <div class="settings-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
            </div>
        </form>
    </div>

    <!-- Logs Section -->
    <div class="admin-section" id="logs">
        <div class="section-header">
            <h2>System Logs</h2>
            <div class="log-filters">
                <select id="logLevel">
                    <option value="">All Levels</option>
                    <option value="error">Error</option>
                    <option value="warning">Warning</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                </select>
                <select id="logType">
                    <option value="">All Types</option>
                    <option value="auth">Authentication</option>
                    <option value="file">File Operations</option>
                    <option value="admin">Admin Actions</option>
                    <option value="system">System</option>
                </select>
                <button class="btn btn-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Clear Logs
                </button>
            </div>
        </div>
        
        <div class="logs-container">
            <div class="log-entry">
                <div class="log-time">2024-01-15 10:30:25</div>
                <div class="log-level error">ERROR</div>
                <div class="log-message">Failed login attempt for user 'admin' from IP 192.168.1.100</div>
            </div>
            <!-- More log entries would be loaded dynamically -->
        </div>
    </div>    <!-- Maintenance Section -->
    <div class="admin-section" id="maintenance">
        <h2>System Maintenance</h2>

        <!-- System Status Card -->
        <div class="system-status-card">
            <h3><i class="fas fa-heartbeat"></i> System Status</h3>
            <div class="status-grid" id="systemStatus">
                <div class="status-item">
                    <label>Current Version:</label>
                    <span id="currentVersion">Loading...</span>
                </div>
                <div class="status-item">
                    <label>Last Update:</label>
                    <span id="lastUpdate">Loading...</span>
                </div>
                <div class="status-item">
                    <label>Git Available:</label>
                    <span id="gitAvailable">Loading...</span>
                </div>
                <div class="status-item">
                    <label>Update Script:</label>
                    <span id="updateScript">Loading...</span>
                </div>
                <div class="status-item">
                    <label>Free Space:</label>
                    <span id="freeSpace">Loading...</span>
                </div>
                <div class="status-item">
                    <label>PHP Version:</label>
                    <span id="phpVersion">Loading...</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="refreshSystemStatus()">
                <i class="fas fa-sync-alt"></i> Refresh Status
            </button>
        </div>
        
        <div class="maintenance-grid">
            <div class="maintenance-card">
                <h3><i class="fas fa-database"></i> Database</h3>
                <p>Optimize and maintain database tables</p>
                <button class="btn btn-primary" onclick="optimizeDatabase()">
                    Optimize Database
                </button>
            </div>
            
            <div class="maintenance-card">
                <h3><i class="fas fa-broom"></i> Cleanup</h3>
                <p>Remove temporary files and clean up storage</p>
                <button class="btn btn-primary" onclick="runCleanup()">
                    Run Cleanup
                </button>
            </div>
            
            <div class="maintenance-card">
                <h3><i class="fas fa-cloud-download-alt"></i> Auto Update</h3>
                <p>Automatically update system from GitHub repository</p>
                <div class="update-controls">
                    <button class="btn btn-warning" onclick="performAutoUpdate()" id="autoUpdateBtn">
                        <i class="fas fa-sync-alt"></i> Update System
                    </button>
                    <div class="update-progress" id="updateProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <span>Updating system...</span>
                    </div>
                </div>
            </div>
            
            <div class="maintenance-card">
                <h3><i class="fas fa-download"></i> Manual Backup</h3>
                <p>Create manual system backup before updates</p>
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="fas fa-archive"></i> Create Backup
                </button>
            </div>
        </div>
        
        <div class="maintenance-log">
            <h3>Maintenance History</h3>
            <div class="log-list">
                {{#maintenance_history}}
                <div class="log-item">
                    <div class="log-icon">
                        <i class="fas {{icon}}"></i>
                    </div>
                    <div class="log-details">
                        <div class="log-action">{{action}}</div>
                        <div class="log-timestamp">{{timestamp}}</div>
                    </div>
                    <div class="log-status {{status}}">{{status_text}}</div>
                </div>
                {{/maintenance_history}}
            </div>
        </div>
    </div>
</div>

<script>
// Admin panel JavaScript
let currentSection = 'dashboard';

function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    // Show selected section
    document.getElementById(section).classList.add('active');
    event.target.classList.add('active');
    
    currentSection = section;
    
    // Load section data if needed
    loadSectionData(section);
}

function loadSectionData(section) {
    switch(section) {
        case 'users':
            loadUsers();
            break;
        case 'files':
            loadFiles();
            break;
        case 'logs':
            loadLogs();
            break;
    }
}

// User management functions
function createUser() {
    // Implementation for creating new user
    console.log('Create user');
}

function editUser(userId) {
    console.log('Edit user:', userId);
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        console.log('Delete user:', userId);
    }
}

function viewUserFiles(userId) {
    console.log('View files for user:', userId);
}

function loginAsUser(userId) {
    if (confirm('Login as this user? This will log you out of admin.')) {
        console.log('Login as user:', userId);
    }
}

function loadUsers() {
    // Load users data
    console.log('Loading users...');
}

// File management functions
function loadFiles() {
    console.log('Loading files...');
}

function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file?')) {
        console.log('Delete file:', fileId);
    }
}

function viewFileShares(fileId) {
    console.log('View shares for file:', fileId);
}

function cleanupOrphaned() {
    if (confirm('Clean up orphaned files? This cannot be undone.')) {
        console.log('Cleanup orphaned files');
    }
}

function regenerateThumbnails() {
    console.log('Regenerate thumbnails');
}

// Storage management functions
function cleanupTempFiles() {
    console.log('Cleanup temp files');
}

function optimizeStorage() {
    console.log('Optimize storage');
}

function runBackup() {
    console.log('Run backup');
}

// Settings functions
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const settings = {};
    
    for (let [key, value] of formData.entries()) {
        settings[key] = value;
    }
    
    // Save settings
    fetch('{{base_url}}/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully!');
        } else {
            alert('Failed to save settings: ' + data.message);
        }
    });
});

function resetSettings() {
    if (confirm('Reset all settings to defaults?')) {
        console.log('Reset settings');
    }
}

// Log management functions
function loadLogs() {
    console.log('Loading logs...');
}

function clearLogs() {
    if (confirm('Clear all logs? This cannot be undone.')) {
        console.log('Clear logs');
    }
}

// Maintenance functions
function optimizeDatabase() {
    console.log('Optimize database');
}

function runCleanup() {
    console.log('Run cleanup');
}

function checkUpdates() {
    console.log('Check updates');
}

function createBackup() {
    console.log('Create backup');
}

// Initialize admin panel
document.addEventListener('DOMContentLoaded', function() {
    loadSectionData('dashboard');
});
</script>
{{/content}}
